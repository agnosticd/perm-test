---
name: Merge Audit

on:
  pull_request:
    types: [closed]

jobs:
  audit-merger:
    name: merge-audit
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Check merger identity
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const merger = pr.merged_by.login;
            const org = context.repo.owner;

            let maintainerLogins;
            try {
              const { data: members } = await github.rest.teams.listMembersInOrg({
                org: org,
                team_slug: 'maintainers',
              });
              maintainerLogins = new Set(members.map(m => m.login));
            } catch (error) {
              core.warning(`Cannot verify merger identity: ${error.message}`);
              return;
            }

            if (!maintainerLogins.has(merger)) {
              const message = `⚠️ **Merge audit warning**: This PR was merged by ` +
                `@${merger}, who is not a member of the maintainers team.\n\n` +
                `The code was reviewed and approved, so no action is required ` +
                `unless this was unauthorized.`;

              await github.rest.issues.createComment({
                owner: org,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: message,
              });

              core.warning(`PR #${pr.number} merged by non-maintainer: ${merger}`);
            } else {
              core.info(`PR #${pr.number} merged by maintainer: ${merger}`);
            }

