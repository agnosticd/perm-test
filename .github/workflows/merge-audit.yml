---
name: Merge Audit

on:
  pull_request:
    types: [closed]

jobs:
  audit-merger:
    name: merge-audit
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Check merger identity
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const merger = pr.merged_by.login;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            let mergerPermission;
            try {
              const { data: permData } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner,
                repo,
                username: merger,
              });
              mergerPermission = permData.permission;
            } catch (error) {
              core.warning(`Cannot verify merger identity: ${error.message}`);
              return;
            }

            if (!['admin', 'maintain'].includes(mergerPermission)) {
              const message = `⚠️ **Merge audit warning**: This PR was merged by ` +
                `@${merger} (permission: \`${mergerPermission}\`), who does not have ` +
                `Maintain or Admin access.\n\n` +
                `The code was reviewed and approved, so no action is required ` +
                `unless this was unauthorized.`;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr.number,
                body: message,
              });

              core.warning(`PR #${pr.number} merged by non-maintainer: ${merger} (${mergerPermission})`);
            } else {
              core.info(`PR #${pr.number} merged by maintainer: ${merger} (${mergerPermission})`);
            }
